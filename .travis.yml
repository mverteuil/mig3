dist: xenial
language: python
python: 3.7
sudo: false

stages:
  - fossa
  - lint
  - test

cache:
  pip: true
  directories:
    - $HOME/.cache/pre-commit

env:
  - DATABASE_URL=postgres://postgres:postgres@localhost:5432/postgres

jobs:
  include:
    - stage: fossa
      install:
        - pip install pip==19.1.1 poetry==0.12.17
      script:
        - poetry install --no-dev
        - "curl -H 'Cache-Control: no-cache' https://raw.githubusercontent.com/fossas/fossa-cli/master/install.sh | sudo bash"
        - pip freeze > requirements.txt
        - fossa analyze
    - stage: lint
      install:
        - pip install pre-commit
        - pre-commit install-hooks
      script:
        - pre-commit run --all-files
    - stage: test
      services:
        - postgresql
      install:
        - pip install pip==19.1.1 poetry==0.12.17
        - poetry install
      before_script:
        - barb -z
      script:
        - python -m pytest
      after_success:
        - pip install codacy-coverage==1.3.11
        - coverage xml
        - python-codacy-coverage -r coverage.xml
